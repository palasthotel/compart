!function(){"use strict";var e={n:function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,{a:n}),n},d:function(t,n){for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r:function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{createPost:function(){return h},createProposal:function(){return i},queryProposals:function(){return u},queryVoting:function(){return m},unvoteForProposal:function(){return E},updateProposalStatus:function(){return p},voteForProposal:function(){return d}});var n=window.wp.element,a=window.wp.domReady,o=e.n(a),r=window.ReactDOM,l=window.wp.apiFetch,s=e.n(l);const c=e=>`${Compart.rest_namespace}${e}`,i=e=>s()({path:c("/proposals"),method:"POST",data:{text:e}}),p=(e,t)=>s()({path:c(`/proposals/${e}`),method:"PATCH",data:{status:t}}),u=function(){let{page:e=1,items_per_page:t=50,search:n="",user_id:a=0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const o=[];return e&&o.push(`page=${e}`),t&&o.push(`items_per_page=${t}`),n.length&&o.push(`search=${encodeURIComponent(n)}`),a&&o.push(`user_id=${a}`),s()({path:c(`/proposals?${o.join("&")}`)})},m=e=>s()({path:c(`/votings/${e}`),method:"GET"}),d=(e,t,n)=>s()({path:c(`/votings/${e}?proposal_id=${t}&reaction=${n}`),method:"POST"}),E=(e,t)=>s()({path:c(`/votings/${e}?proposal_id=${t}`),method:"DELETE"}),h=(e,t)=>s()({path:c(`/votings/${e}/proposal/${t}/create-post`),method:"POST"});function g(){return g=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},g.apply(this,arguments)}window.React;var v=e=>{let{children:t}=e;return(0,n.createElement)("ul",{style:{margin:0}},t)},_=window.wp.components;const f=e=>{const{summary:t,percentage:a}=e,o=`${Math.round(100*a)}%`;return(0,n.createElement)("li",{className:"proposal-list-item  proposal-list-item__stats"},(0,n.createElement)("div",null,t),(0,n.createElement)("div",{className:"proposal__percentage-wrapper"},(0,n.createElement)("div",{className:"proposal__percentage-counter"},o),(0,n.createElement)("div",{className:"proposal__percentage-bar",style:{width:o}})))},b=e=>{const{summary:t,canMoveUp:a,canMoveDown:o,canDelete:r,onMoveDown:l,onMoveUp:s,onTrash:c}=e;return(0,n.createElement)("li",{className:"proposal-list-item proposal-list-item__draft"},a&&(0,n.createElement)("button",{className:"proposal-list-item__button proposal-list-item__button-up",onClick:e=>{e.preventDefault(),s()}},(0,n.createElement)(_.Dashicon,{icon:"arrow-up"})),(0,n.createElement)("div",null,t),o&&(0,n.createElement)("button",{className:"proposal-list-item__button proposal-list-item__button-down",onClick:e=>{e.preventDefault(),l()}},(0,n.createElement)(_.Dashicon,{icon:"arrow-down"})),r&&(0,n.createElement)("button",{className:"proposal-list-item__button proposal-list-item__button-trash",onClick:e=>{e.preventDefault(),c()}},(0,n.createElement)(_.Dashicon,{icon:"trash"})))};var y=e=>{let{status:t,selectedProposalIds:a,generatePost:o}=e;return(0,n.createElement)(n.Fragment,null,(0,n.createElement)("input",{type:"hidden",name:"voting_proposal_form",value:"true"}),(0,n.createElement)("input",{type:"hidden",name:"voting_status",value:t}),a.map((e=>(0,n.createElement)("input",{key:e,type:"hidden",name:"voting_proposals[]",value:e}))),o&&(0,n.createElement)("input",{type:"hidden",name:"voting_generate_post",value:o}))},w=e=>{let{proposals:t,onAddProposal:a}=e;const{i18n:o}=Compart,[r,l]=(0,n.useState)("");return(0,n.createElement)(n.Fragment,null,(0,n.createElement)("label",null,o.add_proposal,(0,n.createElement)("br",null),(0,n.createElement)("select",{style:{width:"100%"},onChange:e=>l(e.target.value)},""===r&&(0,n.createElement)("option",null,"- ",o.select_proposal," -"),t.map((e=>(0,n.createElement)("option",{key:e.id,value:e.id},e.summary))))),(0,n.createElement)("button",{className:"button button-secondary",onClick:e=>{e.preventDefault(),""!==r&&(a(r),l(""))}},o.add_proposal_btn))};const D={DRAFT:"draft",OPEN:"open",FINISHED:"finished"},P="is-active",C="is-done",N="is-available",F="is-disabled",O=e=>{const t=["voting-step__item"];return t.push(e),t.join(" ")},S=e=>{let{status:t,canOpen:a,onOpen:o}=e;const{i18n:r}=Compart;return D.DRAFT!==t?null:(0,n.createElement)("button",{className:"button button-secondary",disabled:!a,onClick:e=>{e.preventDefault(),a&&o()}},r.start_voting_btn)},T=e=>{let{status:t,canFinish:a,onFinish:o}=e;const{i18n:r}=Compart;return D.OPEN!==t?null:(0,n.createElement)("button",{className:"button button-secondary",disabled:!a,onClick:e=>{e.preventDefault(),a&&o()}},r.end_voting_btn)};var I=e=>{let{status:t,canOpen:a=!1,canFinish:o=!1,isFinished:r=!1}=e;const{i18n:l}=Compart;let s=P,c=a?N:F,i=o?N:F;switch(t){case D.OPEN:s=C,c=P;break;case D.FINISHED:s=C,c=C,i=P}return(0,n.createElement)("div",{className:"voting-steps"},(0,n.createElement)("div",{className:O(s)},"1. ",l.step_draft," ",t!==D.DRAFT?"âœ…":""),(0,n.createElement)("div",{className:O(c)},"2. ",l.step_open," ",[D.DRAFT,D.OPEN].includes(t)?"":"âœ…"),(0,n.createElement)("div",{className:O(i)},"3. ",l.step_finished," ",r?"âœ…":""))};const $=e=>{let{winner:t}=e;const{i18n:a}=Compart;return(0,n.createElement)("p",{style:{textAlign:"center",fontSize:"1.2rem"}},(0,n.createElement)("strong",null,a.winner_is),(0,n.createElement)("br",null),t.summary," ðŸŽ‰",(0,n.createElement)("br",null),(0,n.createElement)("br",null))},A=e=>{let{winner:t,generate:a,onChange:o}=e;const{i18n:r}=Compart;return(0,n.createElement)("p",{style:{textAlign:"center",fontSize:"1.2rem"}},(0,n.createElement)("label",null,(0,n.createElement)("input",{type:"checkbox",value:a,onChange:()=>{o(""===a?t.id:"")}})," ",r.create_post))},R=e=>{let{post_title:t,edit_post_url:a}=e;const{i18n:o}=Compart;return(0,n.createElement)("p",{style:{textAlign:"center",fontSize:"1.2rem"}},(0,n.createElement)("strong",null,o.post),(0,n.createElement)("br",null),(0,n.createElement)("a",{href:a},t))};var M=e=>{let{proposals:t,reactions:a,connection:o,generatePost:r,onChangeGeneratePost:l}=e;const s=((e,t)=>{const n=t.reduce(((e,t)=>{const{proposalId:n}=t;return"number"!=typeof e[n]&&(e[n]=0),e[n]=e[n]+1,e}),{});let a=null;for(const e in n)(null===a||n[a]<n[e])&&(a=e);return e.find((e=>parseInt(e.id)===parseInt(a)))})(t,a);return(0,n.createElement)("div",null,s&&(0,n.createElement)($,{winner:s}),!o&&(0,n.createElement)(A,{winner:s,generate:r,onChange:l}),o&&(0,n.createElement)(R,o))},k=e=>{let{proposals:t,reactions:a,status:o,selection:r,connection:l}=e;const{i18n:s}=Compart,[c,i]=(0,n.useState)(o||D.OPEN),[p,u]=(0,n.useState)(r.map((e=>e.id))||[]),[m,d]=(0,n.useState)(""),E=c!==o,h=r.length!==p.length||p.filter(((e,t)=>e!==r[t].id)).length>0,_=E||h,P=(e,t)=>{const n=p[e],a=p[t],o=[...p];o[e]=a,o[t]=n,u(o)},C=[...r,...t],N=p.length>1,F=a.length>1;return(0,n.createElement)("div",{className:"app-voting "+(_?"is-changed":"")},(0,n.createElement)(I,{status:c,canOpen:N,canFinish:F,isFinished:null!==l}),(0,n.createElement)("div",{className:"app-voting__changed-status"},s.save_changes),(0,n.createElement)(y,{status:c,generatePost:m,selectedProposalIds:p}),(0,n.createElement)("div",{className:"app-voting__content"},c===D.DRAFT&&(0,n.createElement)(w,{proposals:t.filter((e=>!p.includes(e.id))),onAddProposal:e=>{u([...p,e])}}),(0,n.createElement)(v,null,p.map(((e,t)=>{let r=C.find((t=>t.id===e));if(null===r)return null;switch(c){case D.DRAFT:return(0,n.createElement)(b,g({key:e},r,{canMoveUp:o===D.DRAFT&&0!==t,canMoveDown:o===D.DRAFT&&t<p.length-1,canDelete:o===D.DRAFT,onMoveUp:()=>{P(t,t-1)},onMoveDown:()=>{P(t,t+1)},onTrash:()=>{(e=>{u(p.filter((t=>t!==e)))})(e)}}));case D.OPEN:case D.FINISHED:const l=a.filter((e=>e.proposalId===r.id)),s=a.length>0?l.length/a.length:0;return(0,n.createElement)(f,g({key:e},r,{reactions:l,percentage:s}))}return null}))),(0,n.createElement)(S,{status:c,canOpen:N,onOpen:()=>{i(D.OPEN)}}),(0,n.createElement)(T,{status:c,canFinish:F,onFinish:()=>{i(D.FINISHED)}}),c===D.FINISHED&&(0,n.createElement)(M,{proposals:C,reactions:a,connection:l,generatePost:m,onChangeGeneratePost:e=>{d(e)}})))};o()((function(){Compart.api=t,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;console.debug("Compart",e,t)}(Compart);const e=document.getElementById("compart-voting-meta-box");e&&(0,r.render)((0,n.createElement)(k,{status:Compart.status||D.DRAFT,proposals:Compart.proposals,selection:Compart.selection,reactions:Compart.reactions,connection:Compart.connection}),e)}))}();